openapi: 3.1.0
info:
  title: Lastmile API
  version: 1.0.0
  description: Public APIs for lastmile integration
  contact:
    name: Platform Support
    email: platform-support@serhafen.com
servers:
  - url: https://api.serhafen-tech.com/lastmile
    description: Production server
  - url: https://api-staging.serhafen-tech.com/lastmile
    description: Staging server
paths:
  /v0/mawbs/{mawbId}:
    patch:
      summary: Update MAWB details
      description: Updates an existing Master Air Waybill (MAWB) with the provided fields. Only the fields provided in the request will be updated.
      operationId: updateMawbDetails
      parameters:
        - name: x-business-unit
          in: header
          required: true
          description: Business unit identifier for multi-tenant routing and data segregation. This header is required for all API requests.
          schema:
            type: string
            enum:
              - serhafen
        - name: x-country-code
          in: header
          required: true
          description: ISO 3166-1 alpha-2 country code representing the country context for the request. Used for country-specific processing and routing.
          schema:
            type: string
            enum:
              - ag
        - name: Authorization
          in: header
          required: true
          description: Bearer token for authenticating API requests. The token must be included in the Authorization header.
          schema:
            type: string
            example: Bearer <token>
        - name: mawbId
          in: path
          required: true
          schema:
            type: string
            pattern: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
          description: MAWB UUID
          example: 018f-1234-5678-9abc-def012345678
        - name: mawbCreatedAt
          in: query
          required: true
          schema:
            type: string
            format: date-time
          description: MAWB creation timestamp (part of composite primary key)
          example: '2024-01-15T08:00:00Z'
      requestBody:
        required: true
        description: MAWB patch request. Only the provided fields will be updated. Fields not included in the request remain unchanged.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMawbDetailsRequest'
            examples:
              basic_edit_mawb_request:
                summary: Basic MAWB edit request
                value:
                  flightNumber: AR1132
                  manifestNumber: MAN-001-1234569
                  bigbagCount: 5
                  totalPackagesDeclared: 8
                  totalWeight: 1500
                  totalWeightUOM: KG
                  referenceNumber: REF-123456789
                  mawbNumber: 125-87654321
                  eta: '2024-01-20T14:30:00Z'
                  etd: '2024-01-18T08:15:00Z'
      responses:
        '200':
          description: MAWB updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateMawbDetailsResponse'
              examples:
                success:
                  summary: Successful MAWB Update
                  value:
                    data:
                      mawbId: 018f1234-5678-9abc-def0-123456789abc
                      mawbNumber: 125-87654321
                      status: UPDATED
                      createdAt: '2024-01-15T10:30:00Z'
                      updatedAt: '2024-01-20T15:45:00Z'
                      manifestNumber: MAN-001-1234569
                      flightNumber: AR1132
                      bigbagCount: 5
                      totalPackagesDeclared: 8
                      totalWeight: 1500
                      totalWeightUOM: KG
                      referenceNumber: REF-123456789
                      eta: '2024-01-20T14:30:00Z'
                      etd: '2024-01-18T08:15:00Z'
                    message: MAWB updated successfully
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateMawbDetailsValidationErrorResponse'
        '404':
          description: MAWB not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateMawbDetailsNotFoundErrorResponse'
        '409':
          description: Business rule violation or version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateMawbDetailsConflictErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateMawbDetailsServerErrorResponse'
      tags:
        - Shipments
  /v0/mawbs/{mawbId}/hawbs:
    get:
      summary: List HAWBs under a MAWB
      description: |
        Returns a paginated list of HAWBs associated with a given MAWB.
        Foreign key relationship: `mawbId` + `mawbCreatedAt`.
      operationId: listHawbs
      parameters:
        - name: x-business-unit
          in: header
          required: true
          description: Business unit identifier for multi-tenant routing and data segregation. This header is required for all API requests.
          schema:
            type: string
            enum:
              - serhafen
        - name: x-country-code
          in: header
          required: true
          description: ISO 3166-1 alpha-2 country code representing the country context for the request. Used for country-specific processing and routing.
          schema:
            type: string
            enum:
              - ag
        - name: Authorization
          in: header
          required: true
          description: Bearer token for authenticating API requests. The token must be included in the Authorization header.
          schema:
            type: string
            example: Bearer <token>
        - name: mawbId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: mawbCreatedAt
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: bigBagNumber
          in: query
          schema:
            type: string
        - name: consigneeIdentificationNumber
          in: query
          schema:
            type: string
        - name: consigneeName
          in: query
          schema:
            type: string
        - name: lastMileTrackingNumber
          in: query
          schema:
            type: string
        - name: clientTrackingNumber
          in: query
          schema:
            type: string
          description: Filter HAWBs by client tracking number (partial match with ILIKE)
        - name: status
          in: query
          schema:
            type: string
            enum:
              - CREATED
              - PENDING_AGENT_VALIDATION
              - CUSTOM_DECLARATION_REJECTED
              - CUSTOMS_DECLARED
              - READY_FOR_CUSTOM_CLEARANCE
              - REQUIRES_CUSTOM_INSPECTION
              - REQUIRES_CUSTOM_DUTY_PAYMENT
              - HANDLER_ATTENTION_RECOMMENDED
              - WH_READY_FOR_CUSTOM_CLEARANCE
              - WH_REQUIRES_CUSTOM_INSPECTION
              - WH_REQUIRES_CUSTOM_DUTY_PAYMENT
              - WH_HANDLER_ATTENTION_REQUIRED
              - CUSTOMS_CLEARED
              - PENDING_CUSTOM_VERIFICATION
              - READY_FOR_HANDOVER
              - HANDED_OVER_TO_LASTMILE
          description: Filter by HAWB status (must match state machine status codes).
        - name: description
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: pageSize
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: sort
          in: query
          schema:
            type: string
            enum:
              - bigBagNumber
              - '-bigBagNumber'
              - lastMileTrackingNumber
              - '-lastMileTrackingNumber'
              - status
              - '-status'
      responses:
        '200':
          description: Successful HAWB list retrieval
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListHawbsSuccessResponse'
        '400':
          description: Bad Request - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: INVALID_REQUEST
                  message: Invalid query parameters provided
                  details:
                    field: mawbCreatedAt
                    error: Invalid date-time format or missing required parameter
                    code: INVALID_FORMAT
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: FORBIDDEN
                  message: Insufficient permissions to access this resource
        '404':
          description: Not Found - MAWB or HAWB not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: RESOURCE_NOT_FOUND
                  message: MAWB not found or no HAWBs exist for the given MAWB
        '500':
          description: Internal Server Error - Unexpected server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: INTERNAL_SERVER_ERROR
                  message: An unexpected error occurred while processing the request
      tags:
        - Shipments
components:
  schemas:
    UpdateMawbDetailsRequest:
      type: object
      properties:
        flightNumber:
          type: string
          maxLength: 20
          description: Flight number
          example: AR1132
        manifestNumber:
          type: string
          maxLength: 50
          pattern: ^[A-Z0-9-]+$
          description: Manifest number
          example: MAN-001-1234569
        bigbagCount:
          type: integer
          minimum: 0
          description: Big bag count
          example: 5
        totalPackagesDeclared:
          type: integer
          minimum: 0
          description: Total packages declared
          example: 8
        totalWeight:
          type: number
          minimum: 0
          description: Total weight
          example: 1500
        totalWeightUOM:
          type: string
          maxLength: 10
          description: Total weight unit of measure
          example: kg
        referenceNumber:
          type: string
          maxLength: 100
          description: Reference number
          example: REF-123456789
        mawbNumber:
          type: string
          maxLength: 20
          description: MAWB number
          example: 125-87654321
        eta:
          type: string
          format: date-time
          description: Estimated time of arrival
          example: '2024-01-20T14:30:00Z'
        etd:
          type: string
          format: date-time
          description: Estimated time of departure
          example: '2024-01-18T08:15:00Z'
    UpdateMawbDetailsResponse:
      type: object
      required:
        - data
        - message
      properties:
        data:
          $ref: '#/components/schemas/UpdateMawbDetailsResponseData'
        message:
          type: string
          description: Response message
          example: MAWB updated successfully
    UpdateMawbDetailsValidationErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/UpdateMawbDetailsValidationErrorResponseError'
    UpdateMawbDetailsNotFoundErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/UpdateMawbDetailsNotFoundErrorResponseError'
    UpdateMawbDetailsConflictErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/UpdateMawbDetailsConflictErrorResponseError'
    UpdateMawbDetailsServerErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/UpdateMawbDetailsServerErrorResponseError'
    ListHawbsSuccessResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/HawbData'
        meta:
          $ref: '#/components/schemas/ListHawbsMeta'
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          $ref: '#/components/schemas/ErrorObject'
    UpdateMawbDetailsResponseData:
      type: object
      required:
        - mawbId
        - mawbNumber
        - status
        - createdAt
      properties:
        mawbId:
          type: string
          pattern: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
          description: UUID of the MAWB that was updated
          example: 018f1234-5678-9abc-def0-123456789abc
        mawbNumber:
          type: string
          description: MAWB number
          example: MAWB-2024-001
        status:
          type: string
          description: Current status of the MAWB
          example: UPDATED
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
          example: '2024-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          description: Update timestamp
          example: '2024-01-15T10:30:00Z'
        manifestNumber:
          type: string
          description: Manifest number
          example: MAN-001-1234569
        flightNumber:
          type: string
          maxLength: 20
          description: Flight number
          example: AR1132
        bigbagCount:
          type: integer
          description: Big bag count
          example: 5
        totalPackagesDeclared:
          type: integer
          description: Total packages declared
          example: 8
        totalWeight:
          type: number
          minimum: 0
          description: Total weight
          example: 1500
        totalWeightUOM:
          type: string
          maxLength: 10
          description: Total weight unit of measure
          example: kg
        referenceNumber:
          type: string
          maxLength: 100
          description: Reference number
          example: REF-123456789
        eta:
          type: string
          format: date-time
          description: Estimated time of arrival
          example: '2024-01-20T14:30:00Z'
        etd:
          type: string
          format: date-time
          description: Estimated time of departure
          example: '2024-01-18T08:15:00Z'
    UpdateMawbDetailsValidationErrorResponseError:
      type: object
      required:
        - code
        - message
        - details
      properties:
        code:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
          example: Request validation failed
        details:
          type: array
          items:
            $ref: '#/components/schemas/UpdateMawbDetailsValidationErrorDetail'
    UpdateMawbDetailsNotFoundErrorResponseError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: MAWB_NOT_FOUND
        message:
          type: string
          example: MAWB not found
    UpdateMawbDetailsConflictErrorResponseError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code indicating conflict type (VERSION_MISMATCH, CONCURRENT_UPDATE)
          example: VERSION_MISMATCH
        message:
          type: string
          description: Human-readable error message
          example: MAWB was modified by another operation. Please reload and retry.
        details:
          type: array
          items:
            $ref: '#/components/schemas/UpdateMawbDetailsValidationErrorDetail'
    UpdateMawbDetailsServerErrorResponseError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: INTERNAL_SERVER_ERROR
        message:
          type: string
          example: An unexpected error occurred
        details:
          type: array
          items:
            $ref: '#/components/schemas/UpdateMawbDetailsValidationErrorDetail'
    HawbData:
      type: object
      required:
        - id
        - mawbId
        - mawbCreatedAt
        - clientId
        - bigBagId
        - bigBagCreatedAt
        - bigBagNumber
        - consigneeName
        - consigneeAddress
        - consigneeCity
        - consigneeCountry
        - consigneeEmail
        - consigneePhone
        - consigneeIdentificationType
        - consigneeIdentificationNumber
        - destinationCountryCode
        - lastMileTrackingNumber
        - grossWeight
        - freightPrice
        - insurancePrice
        - declaredPrice
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the HAWB record.
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the HAWB was created.
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the HAWB was last updated.
        clientId:
          type: string
          format: uuid
          description: Unique identifier of the client that owns this HAWB.
        destinationCountryCode:
          type: string
          pattern: ^[A-Z]{2}$
          description: ISO 3166-1 alpha-2 country code for the destination.
        lastMileTrackingNumber:
          type: string
          maxLength: 100
          description: Tracking number used by the last-mile carrier.
        bigBagId:
          type: string
          format: uuid
          nullable: true
          description: ID of the parent Big Bag (if any).
        bigBagCreatedAt:
          type: string
          format: date-time
          nullable: true
          description: Creation timestamp of the Big Bag.
        bigBagNumber:
          type: string
          maxLength: 50
          nullable: true
          description: Unique identifier for the Big Bag.
        mawbId:
          type: string
          format: uuid
          description: Foreign key reference to the MAWB.
        mawbCreatedAt:
          type: string
          format: date-time
          description: ISO timestamp of the MAWB creation date (used in partitioning).
        consigneeName:
          type: string
        consigneeAddress:
          type: string
        consigneeCity:
          type: string
        consigneeCountry:
          type: string
          pattern: ^[A-Z]{2}$
        consigneeEmail:
          type: string
          format: email
        consigneePhone:
          type: string
        consigneeIdentificationType:
          type: string
          enum:
            - PASSPORT
            - NATIONAL_ID
            - TAX_ID
            - OTHER
        consigneeIdentificationNumber:
          type: string
        returnName:
          type: string
        returnAddress:
          type: string
        returnCity:
          type: string
        returnCountry:
          type: string
          pattern: ^[A-Z]{2}$
        returnEmail:
          type: string
          format: email
        returnPhone:
          type: string
        grossWeight:
          type: number
          format: float
        netWeight:
          type: number
          format: float
        weightUom:
          type: string
          enum:
            - KG
            - LB
        pieces:
          type: integer
          minimum: 0
        dangerousGoods:
          type: boolean
        freightPrice:
          type: number
          format: float
        insurancePrice:
          type: number
          format: float
        declaredPrice:
          type: number
          format: float
        goodsPrice:
          type: string
        currency:
          type: string
          pattern: ^[A-Z]{3}$
          description: ISO 4217 currency code.
        customsClearanceMode:
          type: string
          enum:
            - STANDARD
            - EXPRESS
            - MIXED
        logisticsOrderCode:
          type: string
        lastmilePartnerCode:
          type: string
        uniqueReferences:
          type: string
          description: Optional JSON string or comma-separated list of unique reference identifiers.
        statusId:
          type: string
          format: uuid
          nullable: true
          description: Foreign key reference to a status table, if applicable.
        status:
          type: string
          nullable: true
          enum:
            - CREATED
            - PENDING_AGENT_VALIDATION
            - CUSTOM_DECLARATION_REJECTED
            - CUSTOMS_DECLARED
            - READY_FOR_CUSTOM_CLEARANCE
            - REQUIRES_CUSTOM_INSPECTION
            - REQUIRES_CUSTOM_DUTY_PAYMENT
            - HANDLER_ATTENTION_RECOMMENDED
            - WH_READY_FOR_CUSTOM_CLEARANCE
            - WH_REQUIRES_CUSTOM_INSPECTION
            - WH_REQUIRES_CUSTOM_DUTY_PAYMENT
            - WH_HANDLER_ATTENTION_REQUIRED
            - CUSTOMS_CLEARED
            - PENDING_CUSTOM_VERIFICATION
            - READY_FOR_HANDOVER
            - HANDED_OVER_TO_LASTMILE
          description: Current status of the HAWB (must match state machine status codes).
          example: CUSTOMS_DECLARED
        createdBy:
          type: string
          maxLength: 100
          description: User or system that created the HAWB.
        updatedBy:
          type: string
          maxLength: 100
          description: User or system that last updated the HAWB.
    ListHawbsMeta:
      type: object
      required:
        - page
        - pageSize
        - hasNextPage
        - hasPreviousPage
      properties:
        page:
          type: integer
          example: 1
        pageSize:
          type: integer
          example: 10
        hasNextPage:
          type: boolean
          example: true
        hasPreviousPage:
          type: boolean
          example: false
    ErrorObject:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: ERROR_CODE
        message:
          type: string
          example: ERROR_MESSAGE
        details:
          type: object
          properties:
            field:
              type: string
              example: ERROR_FIELD
            error:
              type: string
              example: ERROR_MESSAGE
            code:
              type: string
              example: ERROR_CODE
          required:
            - field
            - error
            - code
    UpdateMawbDetailsValidationErrorDetail:
      type: object
      required:
        - field
        - error
        - code
      properties:
        field:
          type: string
          description: Field name that failed validation
          example: flightNumber
        error:
          type: string
          description: Human-readable error message
          example: Invalid flight number format
        code:
          type: string
          description: Machine-readable error code
          example: INVALID_FORMAT
  securitySchemes: {}
tags:
  - name: Shipments
    description: Shipments operations
security: []
